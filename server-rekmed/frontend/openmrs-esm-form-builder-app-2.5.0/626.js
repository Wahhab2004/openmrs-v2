"use strict";(globalThis.webpackChunk_openmrs_esm_form_builder_app=globalThis.webpackChunk_openmrs_esm_form_builder_app||[]).push([[626],{40626:(e,n,r)=>{r.r(n),r.d(n,{ProgramEnrollmentSubmissionAction:()=>d,default:()=>p});var t=r(81132),o=r(11261),l=r(65167),i=r.n(l),a=r(63397);function s(e,n,r,t,o,l,i){try{var a=e[l](i),s=a.value}catch(e){return void r(e)}a.done?n(s):Promise.resolve(s).then(t,o)}var u,c,d={applyAction:(u=function(e,n){var r,l,s,u,c,d,p,m,f,h,v,g,b,w,E,y,P,k;return function(e,n){var r,t,o,l,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return l={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(l[Symbol.iterator]=function(){return this}),l;function a(l){return function(a){return function(l){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,t&&(o=2&l[0]?t.return:l[0]?t.throw||((o=t.return)&&o.call(t),0):t.next)&&!(o=o.call(t,l[1])).done)return o;switch(t=0,o&&(l=[2&l[0],o.value]),l[0]){case 0:case 1:o=l;break;case 4:return i.label++,{value:l[1],done:!1};case 5:i.label++,t=l[1],l=[0];continue;case 7:l=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==l[0]&&2!==l[0])){i=0;continue}if(3===l[0]&&(!o||l[1]>o[0]&&l[1]<o[3])){i.label=l[1];break}if(6===l[0]&&i.label<o[1]){i.label=o[1],o=l;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(l);break}o[2]&&i.ops.pop(),i.trys.pop();continue}l=n.call(e,i)}catch(e){l=[6,e],t=0}finally{r=o=0}if(5&l[0])throw l[1];return{value:l[0]?l[1]:void 0,done:!0}}([l,a])}}}(this,(function(T){switch(T.label){case 0:return r=e.patient,l=e.encounters,s=e.sessionMode,m=l[0],f=m.location.uuid,h=(0,a.useTranslation)().t,"view"===s?[2]:(v=null===(c=m.obs)||void 0===c||null===(u=c.find((function(e){return e.formFieldPath.includes(n.enrollmentDate)})))||void 0===u?void 0:u.value,g=null===(p=m.obs)||void 0===p||null===(d=p.find((function(e){return e.formFieldPath.includes(n.completionDate)})))||void 0===d?void 0:d.value,(b=n.programUuid)?(w=new AbortController,E={patient:r.id,program:b,dateEnrolled:v?i()(v).format():null,dateCompleted:g?i()(g).format():null,location:f},"enter"!==s?[3,2]:[4,(0,o.getPatientEnrolledPrograms)(r.id)]):[3,5]);case 1:return(y=T.sent())?(y.results.some((function(e){return e.program.uuid===b&&null===e.dateCompleted}))&&(0,t.showToast)({title:h("enrollmentFailed","Enrollment failed"),kind:"error",critical:!1,description:h("cannotEnrollPatientToProgram","This patient is already enrolled in the selected program")}),[2]):((0,o.createProgramEnrollment)(E,w).then((function(e){201===e.status&&(0,t.showToast)({critical:!0,kind:"success",description:h("enrolledToProgram","Patient enrolled into ${programName}"),title:h("enrollmentSaved","Enrollment saved")})}),(function(e){(0,t.showToast)({title:h("errorEnrolling","Error saving enrollment"),kind:"error",critical:!1,description:h(null==e?void 0:e.message)})})),[3,4]);case 2:return[4,(0,o.getPatientEnrolledPrograms)(r.id)];case 3:P=T.sent(),k=null,P&&(k=P.results.find((function(e){return e.program.uuid===b&&null===e.dateCompleted}))),k&&(E.dateEnrolled||(E.dateEnrolled=k.dateEnrolled),(0,o.updateProgramEnrollment)(k.uuid,E,w).then((function(e){200===e.status&&(0,t.showToast)({critical:!0,kind:"success",description:h("enrollmentUpdateSuccess","Updates to the program enrollment were made successfully"),title:h("enrollmentUpdated","Enrollment updated")})}),(function(e){(0,t.showToast)({title:h("errorSavingEnrollment","Error saving enrollment"),kind:"error",critical:!1,description:null==e?void 0:e.message})}))),T.label=4;case 4:return[3,6];case 5:throw new Error("Please provide Program Uuid to enroll patient to.");case 6:return[2]}}))},c=function(){var e=this,n=arguments;return new Promise((function(r,t){var o=u.apply(e,n);function l(e){s(o,r,t,l,i,"next",e)}function i(e){s(o,r,t,l,i,"throw",e)}l(void 0)}))},function(e,n){return c.apply(this,arguments)})};const p=d}}]);